# SentinelCore MQTT 协议规范

## 1. 引言
本文档定义了 **SentinelCore** 系统内通信使用的 MQTT 主题和有效载荷格式，包括设备到云端的数据传输和云端到设备的控制命令。

## 2. 一般规则
- 所有消息均使用 JSON 作为有效负载格式。
- 所有时间戳均为 Unix 毫秒（UTC）。
- 生产部署必须具备安全性（身份验证、授权、TLS）。

## 3. 设备表示 (`{device_id}`)
系统中的每个 SentinelCore 设备（IMX6ULL）都必须具有唯一的标识符。
- **格式:** UUIDv4（例如 `d61d5600-e343-4c57-8ae3-9c8e88e8e8e8`）或 MAC 地址（例如 `00-11-22-AA-BB-CC`）。
- **生成:** 对于 IMX6ULL，优先使用其 MAC 地址生成一致的 UUID，或者直接使用 MAC 地址。

## 4. MQTT 话题定义

### 4.1 设备状态 & 传感器数据话题 (Sentinel -> Cloud)

|              Topic Path               |               Description               | QoS |  Retain  | Example Payload |
| :-----------------------------------: | :-------------------------------------: | :-: | :------: | :-------------: |
|     `sentinel/{device_id}/status`     |          Device system metrics          | 0/1 | Optional |     See 5.1     |
| `sentinel/{device_id}/{sensors_type}` |      Environmental sensor readings      | 0/1 |    No    |     See 5.2     |
|    `sentinel/{device_id}/response`    | Sentinel's response to control commands |  1  |    No    |     See 5.4     |

### 4.2 控制 & 命令话题 (Cloud -> Sentinel)

|           Topic Path           |         Description         | QoS | Retain | Example Payload |
| :----------------------------: | :-------------------------: | :-: | :----: | :-------------: |
| `app/{app_id}/control` | Commands sent to the device |  1  |   No   |     See 5.3     |

### 4.3 设备连接状态话题

|          Topic Path           |         Description          | QoS | Retain | LWT |                  Example Payload                   |
| :---------------------------: | :--------------------------: | :-: | :----: | :-: | :------------------------------------------------: |
| `sentinel/{device_id}/online` | Device online/offline status |  1  |  Yes   | Yes | See 5.5 (for both online and LWT offline messages) |

## 5. MQTT 有效负载格式 (Payload Formats) - `JSON`

### 5.1 `sentinel/{device_id}/status` Payload
```json
{
  "timestamp_ms": 1701388800123,
  "cpu_temp_c": 58.5,
  "mem_usage_percent": 0.45,
  "uptime_seconds": 3600,
  "network_rx_kbps": 120,
  "network_tx_kbps": 80
}
```
**字段：**
- `timestamp_ms`：（长整型）Unix 时间戳（以毫秒为单位）。
- `cpu_temp_c`：（浮点型）CPU 温度（以摄氏度为单位）。
- `mem_usage_percent`：（浮点型）内存使用率百分比（0.0 至 1.0）。
- `uptime_seconds`：（长整型）设备正常运行时间（以秒为单位）。
- `network_rx_kbps`：（整数型）网络接收速率（以 KB/s 为单位）。
- `network_tx_kbps`：（整数型）网络传输速率（以 KB/s 为单位）。

### 5.2 `sentinel/{device_id}/{sensors_type}` Payload
#### 5.2.1 温湿度传感器数据
`sentinel/{device_id}/temperature_humidity`
```json
{
  "timestamp_ms": 1701388800567,
  "temperature_c": 25.3,
  "humidity_percent": 60.1,
  "sensor_id": "dht11_01"
}
```
**字段：**
- `timestamp_ms`：（长整型）Unix 时间戳（以毫秒为单位）。
- `temperature_c`：（浮点型）温度（以摄氏度为单位）。
- `humidity_percent`：（浮点型）湿度（以百分比为单位）。
- `light_lux`：（整数型）环境光强度（以勒克斯为单位）。
- `sensor_id`：（字符串，可选）如果存在多个相同类型的传感器，则为特定传感器的唯一标识符。

#### 5.2.2 环境光传感器数据
`sentinel/{device_id}/light`
```json
{
  "timestamp_ms": 1701388800567,
  "light_lux": 500,
  "infrared_cd": 120,
  "sensor_id": "ap3216c_01"
}
```
**字段：**
- `timestamp_ms`：（长整型）Unix 时间戳（以毫秒为单位）。
- `light_lux`：（整数型）环境光强度（以勒克斯为单位）。
- `infrared_cd`：（整数型）红外线强度（以坎德拉为单位）。
- `sensor_id`：（字符串，可选）如果存在多个相同类型的传感器，则为特定传感器的唯一标识符。

### 5.3 `app/{app_id}/control` Payload
```json
{
  "command_id": "CTL_LED_20231201_123456",
  "target": "gpio_led_alarm",
  "action": "set_state",
  "value": 1,
  "device_specific_params": {
    "duration_ms": 500
  }
}
```
**字段：**
- `command_id`：（字符串）此命令的唯一标识符，用于跟踪响应并确保幂等性。
- `target`：（字符串）要控制的硬件组件的名称（例如，“gpio_led_alarm”、“bluetooth_speaker”）。
- `action`：（字符串）要执行的具体操作（例如，“set_state”、“toggle”、“get_status”、“play_audio”）。
- `value`：（整数/浮点数/字符串，可选）操作的参数。
- `device_specific_params`：（对象，可选）用于附加命令特定参数的 JSON 对象。

### 5.4 `sentinel/{device_id}/response` Payload
```json
{
  "command_id": "CTL_LED_20231201_123456",
  "status": "success",
  "message": "LED state set to ON",
  "error_code": 0,
  "result_data": {
    "current_state": 1
  }
}
```
**字段：**
- `command_id`：（字符串）此响应所针对的命令的 ID。
- `status`：（字符串）执行状态：“success”、“failure”、“partially_success”。
- `message`：（字符串，可选）用户可读的解释或错误消息。
- `error_code`：（整数，可选）数字错误代码（0 表示成功）。
- `result_data`：（对象，可选）命令执行返回的任何数据。

### 5.5 `sentinel/{device_id}/online` Payload
在线留言 & LWT 离线留言:
```json
{
  "status": "online",  // or "offline" for LWT
  "timestamp_ms": 1701388800000 
}
```
**字段：**
- `status`：（字符串）“online”或“offline”。
- `timestamp_ms`：（长整型）状态发生变化时的 Unix 时间戳（以毫秒为单位）。

## 6. 安全注意事项
- **身份验证**：所有客户端均使用 MQTT 用户名/密码。
- **授权 (ACL)**：配置代理 ACL 以限制每个用户的发布/订阅权限。
- **加密**：所有 MQTT 连接均使用 TLS/SSL（端口 8883），尤其是在公共网络上。

## 7. 错误处理策略
- 代理将在失败时使用指数退避算法重试 MQTT 连接。
- 代理上的命令解析错误将导致“响应”消息，其中包含“status: "failure"”。
- 代理上的发布失败将被记录并在 QoS > 0 时重试。


